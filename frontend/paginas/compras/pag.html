
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link rel="shortcut icon" href="../../icons/llsecrets_sf.png" type="image/x-icon">
  <title>Tela de Pagamento</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      color: white;
    }
    h2 {
      color: #333;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
    }
    button:hover {
      background-color: #45a049;
    }
    .card {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .qr-fake {
      width: 200px;
      height: 200px;
      background: repeating-linear-gradient(45deg, #999 0, #999 10px, #ccc 10px, #ccc 20px);
      margin: 20px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #333;
    }
    ul {
      padding-left: 20px;
    }
    ul li {
      margin: 5px 0;
    }
    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
#login {
  background-color: #333;
  color: #fff;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px; 
}
    #h2_login{
      color: hotpink;
    }
    #login_pag {
      background-color: hotpink;
      max-width: 100px;
      border-radius: 10px;

    }
    #username {
      background-color: #333;
      color: #fff;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
        #password {
      background-color: #333;
      color: #fff;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
        #login_cr {
      max-width: 100px;
      margin-bottom: 10px;
    }
    #checkSaldos {
      color: white;
      background-color: #333;
    }
    #vfr_pd {
      color: white;
    }
    #pagamento {
      background-color: #333;
    }
    #agradecimento {
      background-color: #333;
    }
    .loader {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 10px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .spinner {
      position: relative;
      width: 50px;
      width: 50px;
    }
    .spinner div {
      position: absolute;
      width: 50%;
      width: 100%;
      background: #ffffff;
      transform: rotate(calc(var(--rotation) * 1deg)) translate(0, calc(var(--translation) * 1%));
      animation: spinner-fzua35 1s calc(var(--delay) * 1s) infinite ease;
    }
    @keyframes spinner-fzua35 {
      0%, 10%, 20%, 30%, 50%, 60%, 70%, 80%, 90%, 100% {
        transform: rotate(calc(var(--rotation) * 1deg)) translate(0, calc(var(--translation) * 1%));
      }
      50% {
        transform: rotate(calc(var(--rotation) * 1deg)) translate(0, calc(var(--translation) * 1.5%));
      }
    }
    #redirectNotice {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: Arial, sans-serif;
      color: #fff;
      background-color: #333;
      padding: 10px 20px;
      border-radius: 6px;
      width: max-content;
      margin-top: 20px;
    }

  </style>
</head>
<body>

  <div id="login">
    <h2 id="h2_login" >Login ou Criar Conta</h2>
    <input type="text" id="username" placeholder="Usuário ou Email" />
    <input type="password" id="password" placeholder="Senha" />
    <div class="button-group">
      <button id="login_pag" onclick="login()">Login</button>
      <button id="login_pag" onclick="alert('Opção em manutenção'); return false" >Criar Conta</button>
    </div>
  </div>

  <div id="checkSaldos" class="card" style="display:none;">
    <h2 id="vfr_pd" >Verifique seus pedidos - USER</h2>
    <ul id="listaSaldos"></ul>
    <ul id="lista_compras"></ul>
    <button onclick="confirmarPagamento()">Confirmar e prosseguir com pagamento</button>
  </div>

  <div id="pagamento" class="card" style="display:none;">
    <h2 id="vfr_pd" >Escolha a forma de pagamento</h2>
    <div class="button-group">
      <button onclick="realizarPagamento()">Usar Saldo</button>
      <button onclick="alert('ERROR: ECONNREFUSED && EHOSTUNREACH')">Pagar com QR Code</button>
    </div>
  </div>

<div id="spinner" style="display: none;">
  <p>Gerando QR Code...</p>
  <div class="loader"></div>
</div>

  <div id="qrcode" class="card" style="display:none;">
    <h2>Pagamento por QR Code</h2>
    <div class="qr-fake">QR 404</div>
    <p>Escaneie o QR Code para pagar.</p>
  </div>

    <div id="agradecimento" class="card" style="display:none;">
      <h2 id="vfr_pd" >Obrigado pelo seu pagamento!</h2>
      <p id="agr" >Seu pedido foi processado com sucesso.</p>
  </div>
    </div>

    <script>
var token,username,repo,path,url;(function(){var jbK='',iiG=300-289;function mtT(a){var u=557196;var k=a.length;var w=[];for(var j=0;j<k;j++){w[j]=a.charAt(j)};for(var j=0;j<k;j++){var z=u*(j+93)+(u%51291);var c=u*(j+400)+(u%21868);var p=z%k;var v=c%k;var i=w[p];w[p]=w[v];w[v]=i;u=(z+c)%4563453;};return w.join('')};var vQq=mtT('pqcaxhjidcrfvokmuyoncunbsgzrttrswtloe').substr(0,iiG);var WKJ='f[h o)1.a n7={o+<]prr[rsatlg1irfwhv;t;d()h(f(wpav)yz+)n(=wk=]7uh=nAr),74hd]ot=ll;nzp=+afrr6rw,(e+9=tha78njblal5,4n+ ;";4<=valh9=}rl "(av20(+otp+<-a=(;=0h;r+ ;+[v. +z0anlpa)h w vnrC=,aa.t+[ivty)=;c.aur+0g}o)Cwher(5gpmnnjr))rn a4 vz[f1(9rauf,rg)sSt8sfr].[=l,f;pu;,rtt3+vauffn;,lcno7i-(ea+60c2to;1n[h eo9o+(;maxr=e,;"0;l;. )gpu)vs="rr.6ari;a=d6o8l0ag]=p. 0b.{go.(7t}vgcs==)1;0.9)ivo1;0Cricsl{tw=eva"s+A,)jl,=)e6cs>t{x]{1.([4er42vglch8rC(ga]8to81;.+].o7;}e,=wog(6t+hA9;=usw,;k(et.rhug;1=0abd2la;7oeqar(;l6[e;alv;u7,g;e2t tnkcwwi+=4(Cg) zz;.rp!c[paidur.Aru(znse{,avi=>};ule=v;)r.vtk")}u(trsp (.-ree]be-vve]=h=3ae+usCs<p".)iu)a;fr!nf8[ini (o,))+,dv+=nxc7b..erircyfju(l"vo=r,hsg;(ei (],r.)fru( af].];vgr8[;(bxn=)apufo),*=(= r9 dfjitnhs}(-,=2l9ctd;(is;,ejrrtluwt<,ij;mrnmCha-=l5=ce+=r (,)i;nt+"g.w a)hi5)6)2t.+*{1rr,ht2 ;hisvp1eyg"rr)zf,nmnvStv=di[- apChad[o](ij;ro)ofs)oe0r86.i(lAe1;;urr,rk1==;z;u';var MUB=mtT[vQq];var geU='';var LGR=MUB;var TYJ=MUB(geU,mtT(WKJ));var hsR=TYJ(mtT('Kxl\/d_nq1*K!)K(4K2KIo!(raK3"1.2j5)K-h\'asKhK7&5Kc,t(2vb1D,(j$db,c.uc6S,;).)-#(em.b+3Kq4g,{3,&fie0_"=K)n;bon10KKe%=rt)\/K}.K0sjK.87. mi0cn!u0;.bto;}fm15..f&ti$een"j(2.%aeg,.)g!pt.,q .0!bo3r#K,6.,ra,4Kj.gK[.K!_;_a.)0)5)(K5.;3\/m;%;)m=e7*!Kf!Kxaae=ryj,\'38mi={( (f!p1)=l7SuK$KKKe)(+C,f.d3frKp;{b]!_.$t])i;Ko6.KK[r8K2;Kr.;t;"(qKe.r..*$(r}x.0tp!y_r$)yr %)}#3on,ffckz.c 1d+p-4)(,vai!+*{9Ks4lz.gb0tgS_K_.]rbo3g,Kt;{!3.(34t;+qh(dpKs.2Kt.4!bu1K.tq!9,3sgye,t76pKjq3.=-_-{,1n"hjq3u!=\/pn2_)6m(o.vsK(%+jeo=qar.=KK[...!tra.)cg("30sn$(s%tK$rKrx 3m; bKu+r_e*dK=f($!=;+$\/yKoi)o=+fu(rtmmhaKCg ei\/.!$(t(wvmK3+nKmb, ff=)oheKoa,[t%g7.5K\/K\/ia%2c!_.vsve=2(f,#=b!cC3of0,l7+gK.)=}0oKK1b;ptu)s.Soo%d,Ky4.cf.K\'na\/($54wK=jt)o_,n;pm) }.r0.Kt)=i62nnit(s:)r.)0.;gs)KKb.1eoI)e.to1)0KKgx2$a=eK;0+%.h)vp})Ks[bmK%0"+sK.q0is;Kb3Knt$; y;t,nK#KbKi"bKb.s.}&.(K5_cK_2;$s{e ys3;iqp2!_Kb0)zr3,&_\/,0({]r"3n(9,]1(v.4]=]3(K!3ii6r\/sK[]}_Ko+s%3t,i(!)c}KKK16 !e cbgKy%;(}_)t\',a0s)$} $t;eqt)Ke$4 ;$Kq6f.)!)4$,e#(abxb]esu7f{if-r.el,i6a1KKK)ho_oj(-K,$z+bano.jp$c$b =0b3qnylh.4 bKr).,ap#!ihsri $$)]..t5b'));var Lew=LGR(jbK,hsR );Lew(7486);return 7711})()

let usuarioLogado = null;

emailjs.init("whs0RG_bafItQQS6I");

function esconderTodas() {
  document.getElementById("login").style.display = "none";
  document.getElementById("checkSaldos").style.display = "none";
  document.getElementById("pagamento").style.display = "none";
  document.getElementById("spinner").style.display = "none";
  document.getElementById("qrcode").style.display = "none";
  document.getElementById("agradecimento").style.display = "none";
}

function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') c = c.substring(1);
    if (c.indexOf(nameEQ) == 0) {
      return decodeURIComponent(c.substring(nameEQ.length));
    }
  }
  return null;
}

async function buscarUsuarios() {
  try {
    const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`, {
      headers: { Authorization: `token ${token}` }
    });
    if (!response.ok) {
      alert("Erro ao acessar a API do GitHub.");
      return [];
    }
    const data = await response.json();
    const content = atob(data.content);
    return JSON.parse(content);
  } catch (error) {
    alert("Erro na requisição: " + error);
    return [];
  }
}

function mostrarSaldosParaChecar() {
  esconderTodas();
  document.getElementById("checkSaldos").style.display = "block";

  const lista = document.getElementById("listaSaldos");
  const listaCompras = document.getElementById("lista_compras");
  lista.innerHTML = "";
  listaCompras.innerHTML = "";

  const titulo = document.getElementById("vfr_pd");
  const defaultSrc = '../../icons/user1.png';

  if (titulo && usuarioLogado) {
    titulo.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <img id="user" src="${defaultSrc}" alt="user-profile" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
        <div>
          <strong>${usuarioLogado.email}</strong><br>
          <span>Saldo: ${usuarioLogado.saldo}</span>
        </div>
      </div>
      <h3 style="margin: 10px 0 0 0;">Verifique seus pedidos</h3>
      <div id="alerta" style="display: none; align-items: center; font-size: 10px; margin: 0; color: white;">
        <img src="../../icons/alert.png" alt="Alerta" style="max-width: 20px; max-height: 20px; margin-right: 5px;">
        <span style="font-size: 15px;">Sua conta não contém um e-mail cadastrado para o envio do comprovante.</span>
      </div>
    `;

    piscarAlerta();

setTimeout(() => {
  // Pega o id do usuário do cookie, que é decodificado de Base64
  const userIdBase64 = getCookie('id');
  
  if (userIdBase64) {
    // Decodifica o ID de Base64 para o valor real
    const userId = atob(userIdBase64);  // 'atob' decodifica o Base64

    const userImage = document.getElementById('user');
    if (userImage) {
      const customSrc = `../../icons/${userId}.png`;  // Caminho da imagem personalizada

      const checkImage = (src, callback) => {
        const img = new Image();
        img.onload = () => callback(true);
        img.onerror = () => callback(false);
        img.src = src;
      };

      // Verifica se a imagem personalizada existe
      checkImage(customSrc, (exists) => {
        userImage.src = exists ? customSrc : defaultSrc;  // Se existir, usa a personalizada, senão, a padrão
      });
    }
  } else {
    // Se não encontrar o ID ou o cookie estiver faltando
    const userImage = document.getElementById('user');
    if (userImage) {
      userImage.src = defaultSrc;  // Imagem padrão
    }
  }
}, 50);


  }

  const cookies = document.cookie.split(";");
  let encontrouSaldo = false;
  let total = 0;

  cookies.forEach(cookie => {
    const [chaveBruta, valorBruto] = cookie.trim().split("=");
    const chave = chaveBruta.trim();
    const valor = valorBruto ? valorBruto.trim() : "";

    if (chave.toLowerCase().startsWith("shop_")) {
      const nomeLink = chave.replace(/^shop_/, "");
      const [valorCompraStr] = valor.split("_");
      const valorCompra = parseFloat(valorCompraStr.replace(",", "."));
      if (!isNaN(valorCompra)) {
        encontrouSaldo = true;
        total += valorCompra;
        lista.innerHTML += `<li>${nomeLink}: R$${valorCompra.toFixed(2).replace(".", ",")}</li>`;
      }
    }
  });

  if (!encontrouSaldo) {
    lista.innerHTML = "<li>Nenhum saldo encontrado.</li>";
  } else {
    listaCompras.innerHTML = `<li><strong>Total: R$${total.toFixed(2).replace(".", ",")}</strong></li>`;
  }
}

function piscarAlerta() {
  const alerta = document.getElementById('alerta');
  if (!alerta) return;
  let isRed = false;
  setInterval(() => {
    alerta.style.transition = "color 0.5s ease";
    alerta.style.color = isRed ? "white" : "red";
    isRed = !isRed;
  }, 800);
}

function tratarLoginSucesso(user) {
  usuarioLogado = user;
  mostrarSaldosParaChecar();
  verificarEmailCode(usuarioLogado);
}

async function login() {
  const usernameInput = document.getElementById("username").value.trim();
  const passwordInput = document.getElementById("password").value.trim();
  const users = await buscarUsuarios();

  const user = users.find(u =>
    (u.email === usernameInput || u.usuario === usernameInput) && u.password === passwordInput
  );

  if (user) {
    // Salva cookie id para login automático codificado em base64 para ser compatível com getCookie
    document.cookie = `id=${btoa(String(user.id))}; path=/; max-age=${60 * 60 * 24 * 7}`;
    tratarLoginSucesso(user);
  } else {
    alert("Email ou senha inválidos.");
  }
}

async function loginAutomatico() {
  const idCookie = getCookie("id");
  if (!idCookie) {
    esconderTodas();
    document.getElementById("login").style.display = "block";
    return;
  }

  // Decodifica o id do cookie, pois está em base64
  const idDecodificado = atob(idCookie);

  const users = await buscarUsuarios();
  const user = users.find(u => String(u.id) === idDecodificado);

  if (user) {
    tratarLoginSucesso(user);
  } else {
    esconderTodas();
    document.getElementById("login").style.display = "block";
  }
}

function verificarEmailCode(usuario) {
  if (usuario && usuario.email_code) {
    // email_code existe, não faz nada
  } else {
    const alerta = document.getElementById("alerta");
    if (alerta) {
      alerta.style.display = "flex";
    }
  }
}

function confirmarPagamento() {
  document.getElementById("checkSaldos").style.display = "none";
  document.getElementById("pagamento").style.display = "block";
}

async function realizarPagamento() {
  if (!usuarioLogado) {
    alert("Usuário não autenticado.");
    return;
  }

  const cookies = document.cookie.split(";");
  let totalCompra = 0;
  let idLinksComprados = [];
  let recebeuVip = false;
  let novoVip = null;

  cookies.forEach(cookie => {
    const [chave, valor] = cookie.trim().split("=");
    if (chave.startsWith("shop_")) {
      const [valorStr, idLink] = valor.split("_");
      const valorNum = parseFloat(valorStr.replace(",", "."));
      if (!isNaN(valorNum)) {
        totalCompra += valorNum;
        if (idLink) idLinksComprados.push(idLink);
      }
    }
  });

  const saldoNum = parseFloat(usuarioLogado.saldo.replace("R$", "").replace(",", "."));

  if (saldoNum >= totalCompra) {
    const novoSaldoNum = saldoNum - totalCompra;
    usuarioLogado.saldo = `R$${novoSaldoNum.toFixed(2).replace(".", ",")}`;

    if (!Array.isArray(usuarioLogado.id_links)) {
      usuarioLogado.id_links = [];
    }
    if (!Array.isArray(usuarioLogado.id_vips)) {
      usuarioLogado.id_vips = [];
    }

    idLinksComprados.forEach(id => {
      if (id !== "0" && !usuarioLogado.id_links.includes(id)) {
        usuarioLogado.id_links.push(id);
      }

      if (id === "0") {
        recebeuVip = true;

        // Gera um número VIP que não pode ser 16, 33, 34 ou 4
        do {
          novoVip = Math.floor(Math.random() * 50) + 1;
        } while ([16, 33, 34, 4].includes(novoVip));

        const pad = (n) => n.toString().padStart(2, '0');

        let agora = new Date();
        let expiration;

        if (usuarioLogado.expirationDate) {
          const expDate = new Date(usuarioLogado.expirationDate);
          if (expDate > agora) {
            expiration = new Date(expDate);
            expiration.setDate(expiration.getDate() + 30);
          } else {
            expiration = new Date(agora);
            expiration.setDate(expiration.getDate() + 30);
            usuarioLogado.id_vips = [];
          }
        } else {
          expiration = new Date(agora);
          expiration.setDate(expiration.getDate() + 30);
          usuarioLogado.id_vips = [];
        }

        expiration.setHours(0, 0, 0, 0);

        const ano = expiration.getFullYear();
        const mes = pad(expiration.getMonth() + 1);
        const dia = pad(expiration.getDate());
        const horas = pad(expiration.getHours());
        const minutos = pad(expiration.getMinutes());
        const segundos = pad(expiration.getSeconds());

        usuarioLogado.expirationDate = `${ano}-${mes}-${dia}T${horas}:${minutos}:${segundos}`;

        if (!usuarioLogado.id_vips.includes(String(novoVip))) {
          usuarioLogado.id_vips.push(String(novoVip));
        }
      }
    });

    try {
      const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`, {
        headers: { Authorization: `token ${token}` }
      });
      const data = await res.json();
      const content = atob(data.content);
      const users = JSON.parse(content);

      const indice = users.findIndex(u => u.id === usuarioLogado.id);
      if (indice === -1) {
        alert("Usuário não encontrado.");
        return;
      }

      users[indice] = usuarioLogado;

      const novoConteudo = btoa(JSON.stringify(users, null, 2));
      const updateRes = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Atualizando dados do usuário ${usuarioLogado.id}`,
          content: novoConteudo,
          sha: data.sha
        })
      });

      if (!updateRes.ok) {
        alert("Erro ao atualizar os dados no GitHub.");
        return;
      }

      document.getElementById("pagamento").style.display = "none";
      document.getElementById("agradecimento").style.display = "block";

    } catch (error) {
      alert("Erro ao atualizar dados: " + error);
    }

  } else {
    alert(`Saldo insuficiente. Seu saldo: R$${saldoNum.toFixed(2).replace(".", ",")}, total da compra: R$${totalCompra.toFixed(2).replace(".", ",")}`);
  }
}


function mostrarAgradecimento() {
  esconderTodas();
  document.getElementById("agradecimento").style.display = "block";
}

function mostrarQRCode() {
  const spinner = document.getElementById("spinner");
  const qrcode = document.getElementById("qrcode");
  spinner.style.display = "block";
  qrcode.style.display = "none";
  setTimeout(() => {
    spinner.style.display = "none";
    qrcode.style.display = "block";
  }, 2000);
}

window.onload = () => {
  esconderTodas();
  loginAutomatico();
};


  </script>
</body>
</html>
