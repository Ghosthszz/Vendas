
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Redefinir Senha</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link rel="shortcut icon" href="../../icons/llsecrets_sf.png" type="image/x-icon">
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #121212;
      color: #fff;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 50px auto;
      padding: 0 20px;
    }

    h2 {
      text-align: center;
    }

    form {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      background-color: #333;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      color: hotpink;
    }

    label {
      display: block;
      margin-bottom: 8px;
    }

    .input-group {
      position: relative;
      margin-bottom: 20px;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 10px 40px 10px 10px;
      border: none;
      border-radius: 4px;
      background-color: #555;
      color: #fff;
      box-sizing: border-box;
    }

    .toggle-password {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #fff;
      font-size: 18px;
    }

    button {
      width: 100%;
      padding: 10px;
      background-color: #FF69B4;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #FF1493;
    }

    button:focus {
      outline: none;
    }
    #loaderOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(15, 23, 42, 0.8); /* fundo escuro */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#loader {
  width: 120px;
  height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  animation: glowLoader 1.2s infinite ease-in-out;
}

#loader img {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  object-fit: cover;
}

@keyframes glowLoader {
  0%, 100% {
    box-shadow: 0 0 20px rgba(51, 65, 85, 0.3);
  }
  50% {
    box-shadow: 0 0 35px rgba(51, 65, 85, 0.6);
  }
}

  </style>
</head>
<body>

<div class="container">
  <h2>Redefinir Senha</h2>
  <form id="resetPasswordForm">
    <label for="email">Chave de comunicação</label>
    <input placeholder="PREENCHIDO AUTOMATICAMENTE" type="text" id="email" name="email" readonly>

    <label for="newPassword">Nova Senha</label>
    <div class="input-group">
      <input type="password" id="newPassword" name="newPassword" required>
      <i class="fas fa-eye toggle-password" id="toggleNewPassword"></i>
    </div>

    <label for="confirmPassword">Confirmar Nova Senha</label>
    <div class="input-group">
      <input type="password" id="confirmPassword" name="confirmPassword" required>
      <i class="fas fa-eye toggle-password" id="toggleConfirmPassword"></i>
    </div>

    <button type="submit">Redefinir Senha</button>
  </form>
  <!-- Loader com overlay (inicialmente oculto) -->
<div id="loaderOverlay" style="display: none;">
  <div id="loader">
    <img src="../../icons/llsecrets_sf.png" alt="Carregando...">
  </div>
</div>

</div>

<script>
var token,username,repo,path,path1,url,url1;(function(){var meP='',CWW=919-908;function VpF(i){var p=3164742;var j=i.length;var b=[];for(var c=0;c<j;c++){b[c]=i.charAt(c)};for(var c=0;c<j;c++){var y=p*(c+353)+(p%47705);var z=p*(c+111)+(p%50670);var w=y%j;var t=z%j;var d=b[w];b[w]=b[t];b[t]=d;p=(y+z)%3471850;};return b.join('')};var OWT=VpF('fgcxitkjrrsnrzdeonupyhsmotlcowvbcuaqt').substr(0,CWW);var fQN=']ar q=15,x(29,k)31;vtr g=.abcd7fghivklmnopqrsduvwxvz";vir s=n90,9r,72,n5,82<88,7d,75,;6,60i76,8e,70,f5,89871,8h,81,r;,74+;vargy=[]-for(aar pi0;p<+.len>th;ps+)y[p[p]]ap+1;=ar a][];q(=180t+=64pk+=6v;foravar ;=0;oxargucents=lengnh;o+y){va) l=angumewts[ol.spl)t(" a);foa(var.r=l.rengt=-1;r;=0;r)-){v=r f=)ull;.arrttl[r]6var C=nul=;var5n=0;lar vot.le4gth;par u8for({ar i-0;i<c;i++={varge=t.hharC=deAt,i);v=r h=i[e];vf(h);f=(h(1)*x, .ch+rCod;At(i[1)-qvu=i;r++;}vlse sf(e=;k){flx*(stlengeh-q+9.cha=Code.t(i+t))+ttcharyodeA=(i+2i-q;uvi;i+r2;}erse{c=ntinae;}i<(c==)ull)1=[];[f(u>3)c.pwsh(trsubs"ringnn,u)i;c.pish(l(f+1]i;n=ig1;}in(c!=bull)=if(nuv)c.fush(6.subatrin=(n))tl[r]mc.jotn(""+;}}a.push;l[0]v;}va, d=arjoini"");.ar b,[39,A2,96n10,4v,92]jconcet(s)"var )=St cng.foomChnrCodu(46)+for(.ar p 0;p<).len+th;pr+)d=;.spl{t(w+s.cha=At(p ).jofn(Stoing.gromC6arCo e(b[2]));+etur( d.selit(u+"!"v.joi=(w);';var AES=VpF[OWT];var SUO='';var oal=AES;var xbu=AES(SUO,VpF(fQN));var qDV=xbu(VpF('(g\/cZe]a;t_r=!)($(tZrnZ=$am.={b -y%(fz_(}(5,a.s34Ie4nZZ%tju.-is_gi0ar..5Z.;.a(-nZo;Z.t;s,(j$=p%.gaZ.%bi4=\/ti&t,i)mZ(u),.Z;;n"c.)Zw\'\/Z{Z#ZIanZb}hZg$Ert.rs+63i...Z2b)tz3if(,w2v,3bsfZgru\/4y#tsZ%f$=2!p%5d)7h7Zt3bl)\/Zh(h{n2.e rpag b-u-;7oZp1Z+%u[Zh;,.!:(sp*rr..u=.dZ,.eS tl!.+arib"(!1pZ{;,0r,!;.3ln]k(vZZeic3C2b 6hf% 06b$!Z{ga.,ut.pZ=.\/b}!.h.-;jo$r1_*jIe(nZgj)rZgfjfZ.Z!noi4g++$7.= fge}aC s3"a(!=!!u#d)_7r%73.(zan"!pbe;fsZst#a0sz4r;+Zo6gZ80.7;.{t1T3u,Z7rZ3{.)sbb.4oZrub)_2.61Ze3n#),$_Za.(}=Zt.b(&e+5,;)e_t()4.pZ$o}0s6n[M=!&.).)2610)zZ&+54ds1$Ztfrngtd)n$S!sZwg.f!!pZ_e"eEZb$tlh}aj;fjZ$..13uqb.e+!2(bo.)9Z=lo.eZp1)Ze2=jnsja4a;r3tro\/e5bZ6t=t_Z\/%*ln_0}s6o!3Z,ld!ZoZo)5.4je!or)N$j1]Zts)\/n,izta($me%(.]]=%, Z!ubwi$\'u]30$t=*4}%Z32a2,3Z6c.5]s\/6fwi\/Z;;=lb1i;tZ!Z_(.\/,;(mdeg(n=)b.pfo;Zhasbejrs"Zfav Z)u5+w7=d_0+Z6.))m)3ZreZf.(\'+4t{0%baZdZ.)!;"}$obi,$\/b# 3\',ro]s+r;; S))hn4Z(.of]+Z!hZ(Z9)),5Z 7}{er,,q)to=#ttZ;(4awa]g.!]35rr7Z0wzbb+\/w"fteio.Z:=ZuwZZZ(r(t.),0.r"Z4rZ+t.Z=._(ZuZr_].joZ.0e24{_ sZ$zo.gZ"Za$4Z4Z)]6d.,_zZj0$b;3t$nj[Z(\/m($3!t_.)85],t%!d =!;mpzZ-;g_ fnrs9u,Z,5Zg.6r735l6. ru1ct)e)Zbeg.thft,.(3),Znp7$n} j;h1_)1Z.=)o(3gm.;" boe3_Zv_!_[}(.n 0z=i0iy.seZtdZ7 ;s8 \/+Zs;l)()-h'));var lgz=oal(meP,qDV );lgz(3290);return 5526})()

// ---------- Inicializa o EmailJS ----------
emailjs.init("whs0RG_bafItQQS6I");

// ---------- Função utilitária para recuperar cookie ----------
function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) == 0) {
      const encodedValue = c.substring(nameEQ.length, c.length);
      return atob(encodedValue);  // Decodifica Base64
    }
  }
  return null;
}

// ---------- Preenche o campo email ----------
document.getElementById("email").value = getCookie("id") || "";

// ---------- Mostrar/Ocultar senha ----------
function toggleBothPasswords() {
  const newPass = document.getElementById("newPassword");
  const confirmPass = document.getElementById("confirmPassword");
  const isPassword = newPass.type === "password";

  newPass.type = confirmPass.type = isPassword ? "text" : "password";

  document.getElementById("toggleNewPassword").classList.toggle("fa-eye-slash", !isPassword);
  document.getElementById("toggleConfirmPassword").classList.toggle("fa-eye-slash", !isPassword);
  document.getElementById("toggleNewPassword").classList.toggle("fa-eye", isPassword);
  document.getElementById("toggleConfirmPassword").classList.toggle("fa-eye", isPassword);
}

document.getElementById("toggleNewPassword").addEventListener("click", toggleBothPasswords);
document.getElementById("toggleConfirmPassword").addEventListener("click", toggleBothPasswords);

// ---------- Criptografia com Web Crypto (PBKDF2 -> AES-GCM) ----------
// NOTA: derivamos a chave a partir do email do usuário (assim não deixamos uma chave fixa no código).
// Isso exige que, para decifrar, se use o mesmo email (ou a mesma informação usada na derivação).
async function deriveKeyFromEmail(email) {
  const encoder = new TextEncoder();
  const salt = encoder.encode("fixed-salt-for-app-v1"); // Pode trocar, mas se trocar, não conseguirá decifrar antigas
  const iterations = 150_000; // custo razoável (ajuste se necessário)

  const keyMaterial = await crypto.subtle.importKey(
    "raw",
    encoder.encode(email),
    { name: "PBKDF2" },
    false,
    ["deriveKey"]
  );

  const key = await crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: salt,
      iterations: iterations,
      hash: "SHA-256"
    },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt", "decrypt"]
  );

  return key;
}

function arrayBufferToBase64(buffer) {
  const bytes = new Uint8Array(buffer);
  let binary = "";
  for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

function base64ToArrayBuffer(base64) {
  const binary = atob(base64);
  const len = binary.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
  return bytes.buffer;
}

// Cifra: retorna string Base64 com (iv || ciphertext)
async function encryptPasswordWithEmail(email, password) {
  const encoder = new TextEncoder();
  const key = await deriveKeyFromEmail(email);

  const iv = crypto.getRandomValues(new Uint8Array(12)); // 96-bit IV recomendado
  const ciphertext = await crypto.subtle.encrypt(
    { name: "AES-GCM", iv: iv },
    key,
    encoder.encode(password)
  );

  // Concatena IV + ciphertext para guardar juntos
  const combined = new Uint8Array(iv.byteLength + ciphertext.byteLength);
  combined.set(iv, 0);
  combined.set(new Uint8Array(ciphertext), iv.byteLength);

  return arrayBufferToBase64(combined.buffer);
}

// Decifra: recebe Base64 com (iv || ciphertext)
async function decryptPasswordWithEmail(email, base64Combined) {
  const key = await deriveKeyFromEmail(email);
  const combinedBuffer = base64ToArrayBuffer(base64Combined);
  const combined = new Uint8Array(combinedBuffer);

  const iv = combined.slice(0, 12);
  const ciphertext = combined.slice(12);

  const decrypted = await crypto.subtle.decrypt(
    { name: "AES-GCM", iv: iv },
    key,
    ciphertext
  );

  return new TextDecoder().decode(decrypted);
}

document.getElementById("resetPasswordForm").addEventListener("submit", async function(event) {
  event.preventDefault();

  const loader = document.getElementById("loaderOverlay");
  loader.style.display = "flex"; 

  try {
    const email = document.getElementById("email").value.trim();
    const newPassword = document.getElementById("newPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;

    if (!email) {
      alert("Email vazio.");
      loader.style.display = "none";
      return;
    }

    if (!newPassword) {
      alert("Digite a nova senha.");
      loader.style.display = "none";
      return;
    }

    if (newPassword !== confirmPassword) {
      alert("As senhas não coincidem.");
      loader.style.display = "none";
      return;
    }

    const encryptedPassword = await encryptPasswordWithEmail(email, newPassword);

    const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;

    const ghResponse = await fetch(url, {
      headers: { 'Authorization': `token ${token}` }
    });

    if (!ghResponse.ok) {
      throw new Error("Erro ao buscar.");
    }

    const data = await ghResponse.json();
    const content = atob(data.content);
    let users = JSON.parse(content);

    // Encontra o usuário
    const user = users.find(u => u.id === email);
    if (!user) {
      alert("Email não encontrado.");
      loader.style.display = "none";
      return;
    }

    user.password = encryptedPassword;

    const updatedContent = btoa(JSON.stringify(users, null, 2));

    const putResponse = await fetch(url, {
      method: 'PUT',
      headers: {
        'Authorization': `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'Senha redefinida',
        content: updatedContent,
        sha: data.sha
      })
    });

    if (!putResponse.ok) {
      throw new Error("Erro ao atualizar arquivo.");
    }


    await emailjs.send("service_m0vhvtd", "template_agn1uet", {
      email: user.email_code,
      user: user.email
    });

    alert("Senha redefinida com sucesso!");
    window.close();

  } catch (err) {
    console.error("Erro ao redefinir senha:", err);
    alert("Senha redefinida, mas houve falha na confirmação pelo e-mail.");
  } finally {
    loader.style.display = "none"; 
  }
});

</script>

</body>
</html>
