<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasta de Arquivos</title>
    <link rel="stylesheet" href="../../css/style.css">
</head>
<style>
#token {
    position: absolute;
    top: 0;
    left: 30px;
    margin: 0;
    padding: 10px;
    font-size: 12px;
    color: gold;
}

@media only screen and (max-width: 768px) {
    #token {
        font-size: 6px;
        padding: 8px;
    }
}

@media only screen and (max-width: 480px) {
    #token {
        font-size: 6px;
        padding: 8px;
    }

    #comp {
        font-size: 14px;
        max-width: 20px;
        left: 70px;
        top: 2px;
        color: red;
    }

    #dark-mode-user {
        top: -30px;
        left: 320px;
        width: 30px;
        height: 30px;
    }

    #userInfo {
        top: 30%;
        left: 15%;
        width: 250px;
        height: 300px;
    }

    #exit {
        left: 283px;
        max-width: 30px;
        max-height: 30px;
    }

    #removeCookiesButton {
        top: 20px;
        left: 222px;
        width: 40px;
        height: 40px;
    }

    #sol {
        top: 481px;
        left: 280px;
        max-width: 30px;
        max-height: 30px;
    }

    #dark-mode-toggle {
        top: 253px;
        left: 215px;
    }

    #bx_dds {
        position: fixed;
        top: 468px;
        left: 55%;
        background-color: #FF69B4;
        padding: 10px 20px;
        font-size: 16px;
        margin: 4px 2px;
        border-radius: 8px;
        transition-duration: 0.4s;
        max-width: 90px;
        max-height: 40px;
    }


    .link-button {
        position: absolute;
        display: inline-block;
        padding: 10px 20px;
        font-size: 16px;
        color: white;
        background-color: #007BFF;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        cursor: pointer;
        text-align: center;
        max-width: 90px;
        max-height: 40px;
        overflow: hidden;
        white-space: nowrap;
        top: 87%;
    }

    .link-button:hover {
        background-color: #0056b3;
    }
}

.rectangle1 {
    position: absolute;
    width: 170px;
    height: auto;
    background-color: rgb(121, 9, 65);
    color: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    top: 70px;
    right: -220px;
}

.rectangle1 h2 {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 1.5em;
    text-align: center;
}

.rectangle1 ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
}

.rectangle1 ul li {
    padding: 10px;
    font-size: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.rectangle1 ul li:last-child {
    border-bottom: none;
}

@media only screen and (max-width: 768px) {
    .rectangle1 {
        width: 200px;
        padding: 15px;
        display: none;
    }
    .teste {
        display: none;
    }
    #past {
        font-size: 25px;
    }
    .container1 {
        display: none;
    }
}

@media only screen and (max-width: 480px) {
    .rectangle1 {
        width: 150px;
        padding: 10px;
        display: none;
    }
}

.teste {
    position: absolute;
    width: 170px;
    height: auto;
    background-color: #333;
    color: #fff;
    left: 10px;
    top: 100px;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

#transferSection {
    display: flex;
    flex-direction: column;
}

#tx {
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 1.5em;
    text-align: center;
}

label {
    margin: 10px 0 5px;
}

input[type="text"],
input[type="number"] {
    width: calc(100% - 20px);
    padding: 10px;
    margin-bottom: 10px;
    border: none;
    border-radius: 5px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.container1 {
    position: absolute;
    margin-top: 50px;
    top: -65px;
    right: -70px;
}

.icon {
    display: none;
}

.show-icon .saldo {
    display: none;
}

.show-icon .icon {
    display: inline;
}

#toggleButton {
    max-width: 40px;
    position: absolute;
    top: 5px;
    right: -70px;
}

</style>
<body>
    <div id="token">
        <h1>Seu cupom: <br>NULL</h1>
    </div>
    <div>
    </div>
    <div id="comp1" class="container">     
        <h1 id="past" >Pasta de Arquivos
         <button id="dark-mode-user"onclick="toggleUserInfo()"><img id="user" src="../../icons/user1.png" alt="user-profile"></button> </h1>
         <div class="container1">
            <p><strong>Saldo:</strong> <span  id="toggleSaldo" class="saldo">****</span><span id="saldo" class="icon">${usuario.saldo}</span></p> <img id="toggleButton" src="../../icons/mostrar.png" alt="oculto">
        </div>
         <ul class="file-list">

            <ul class="pagination">
            <li><a href="#comp1">1</a></li>
            <li><a href="#comp2">2</a></li>
            <li><a href="#3">3</a></li>
        </ul>
        </ul>

        <div class="rectangle1">
            <h2 id="tx">Amigos</h2>
            <ul id="listaAmigos">
            </ul> <br> <br>

            <h2 id="tx">Adicionar</h2>
            <input type="text" id="friendId" placeholder="ID do amigo">
            <button id="bx_dd" onclick="adicionarAmigo()">Adicionar Amigo</button>
        </div>

        <h1>VIP:</h1>
        <div id="countdown-container">
            <div id="countdown"></div>
        </div>
    </div>
    <div id="overlay"></div>
    <div id="userInfo" style="display: none;">
        <h2>User Info</h2>
        <p><strong>Name:NULL</strong></p>
        <p><strong>Email:NULL</strong></p>
        <p><strong>Packs:NULL</strong></p>
        <p><strong>Saldo disponível:NULL</strong></p>
        <p><strong>Chave de comunicação:NULL</strong></p>
        <br>
        <button id="bx_dds">Baixar dados</button>
        <button id="removeCookiesButton"><img id="exit" src="../../icons/exit.png" alt="sair"></button>
        <a class="link-button" href="https://ghosthszz.github.io/Vendas/frontend/paginas/login/reset.html" target="_blank">Mudar senha</a>
    </div>
        <div class="teste">
        <div id="transferSection">
            <h2 id="tx" >Transferir Saldo</h2>
            <label for="recipientId">ID do Destinatário:</label>
            <input placeholder="APENAS ID" type="text" id="recipientId" required>
            <label  for="transferAmount">Valor a Transferir:</label>
            <input placeholder="0,00" type="number" id="transferAmount" required>
            <button id="bx_dds" onclick="transferirSaldo()">Transferir</button>
            
        </div>

</body>
<script>
document.getElementById('toggleButton').addEventListener('click', function() {
    const saldoElement = document.getElementById('toggleSaldo').parentNode;
    saldoElement.classList.toggle('show-icon');
});


function transferirSaldo() {
    const userIdFromCookie = getCookie('id');
    const recipientIdElement = document.getElementById('recipientId');
    const recipientId = "user_" + recipientIdElement.value;
    const transferAmount = parseFloat(document.getElementById('transferAmount').value);

    if (userIdFromCookie && recipientId && !isNaN(transferAmount)) {
        fetch(url, {
            headers: {
                Authorization: `token ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            let content = atob(data.content);
            let jsonData = JSON.parse(content);

            let sender = jsonData.find(user => user.id === userIdFromCookie);
            let recipient = jsonData.find(user => user.id === recipientId);

            if (sender && recipient) {
                let senderBalance = parseFloat(sender.saldo.replace('R$', '').replace(',', '.'));
                if (senderBalance >= transferAmount) {
                    sender.saldo = `R$${(senderBalance - transferAmount).toFixed(2).replace('.', ',')}`;
                    let recipientBalance = parseFloat(recipient.saldo.replace('R$', '').replace(',', '.'));
                    recipient.saldo = `R$${(recipientBalance + transferAmount).toFixed(2).replace('.', ',')}`;


                    let updatedContent = btoa(JSON.stringify(jsonData));
                    fetch(url, {
                        method: 'PUT',
                        headers: {
                            Authorization: `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Update user balances',
                            content: updatedContent,
                            sha: data.sha
                        })
                    }).then(() => {
                        alert('Transferência realizada com sucesso!');
                        location.reload();
                    }).catch(error => {
                        console.error('Erro ao atualizar dados:', error);
                    });
                } else {
                    alert('Saldo insuficiente.');
                }
            } else {
                alert('Usuário não encontrado.');
            }
        })
        .catch(error => console.error('Erro ao carregar dados:', error));
    } else {
        alert('Por favor, preencha todos os campos corretamente.');
    }
}

function adicionarAmigo() {
    const userIdFromCookie = getCookie('id'); 
    const friendIdElement = document.getElementById('friendId');
    const friendId = "user_" + friendIdElement.value; 

    if (userIdFromCookie && friendId) {
        fetch(url, {
            headers: {
                Authorization: `token ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            let content = atob(data.content);
            let jsonData = JSON.parse(content);

            let user = jsonData.find(user => user.id === userIdFromCookie);

            if (user) {
                if (!user.friends || !Array.isArray(user.friends)) {
                    user.friends = [];
                }

                if (!user.friends.includes(friendId)) {
                    user.friends.push(friendId); 

                    let updatedContent = btoa(JSON.stringify(jsonData));
                    fetch(url, {
                        method: 'PUT',
                        headers: {
                            Authorization: `token ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: 'Add friend to user',
                            content: updatedContent,
                            sha: data.sha
                        })
                    }).then(() => {
                        alert('Amigo adicionado com sucesso!');
                        location.reload();
                    }).catch(error => {
                        console.error('Erro ao atualizar dados:', error);
                    });
                } else {
                    alert('Esse usuário já está na sua lista de amigos.');
                }
            } else {
                alert('Usuário não encontrado.');
            }
        })
        .catch(error => console.error('Erro ao carregar dados:', error));
    } else {
        alert('Por favor, preencha todos os campos corretamente.');
    }
}

function formatTimeLeft(time) {
    const days = Math.floor(time / (1000 * 60 * 60 * 24));
    const hours = Math.floor((time % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((time % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((time % (1000 * 60)) / 1000);
    return `${days} dias ${hours} horas ${minutes} minutos ${seconds} segundos`;
}




function carregarAmigos() {
        const userIdFromCookie = getCookie('id');

        if (userIdFromCookie) {
            fetch(url, {
                headers: {
                    Authorization: `token ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                let content = atob(data.content);
                let jsonData = JSON.parse(content);

                let user = jsonData.find(user => user.id === userIdFromCookie);

                if (user && user.friends && user.friends.length > 0) {
                    let listaAmigosElement = document.getElementById('listaAmigos');
                    listaAmigosElement.innerHTML = ''; 

                    user.friends.forEach(friendId => {
                        let amigo = jsonData.find(u => u.id === friendId);
                        if (amigo) {
                            let listItem = document.createElement('li');
                            listItem.innerHTML = `<strong>${amigo.name}</strong> (${friendId})`; 
                            listaAmigosElement.appendChild(listItem);
                        }
                    });
                } else {
                    let listaAmigosElement = document.getElementById('listaAmigos');
                    listaAmigosElement.innerHTML = '<li>Nenhum amigo encontrado.</li>';
                }
            })
            .catch(error => console.error('Erro ao carregar dados:', error));
        } else {
            console.error('ID do usuário não encontrado.');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        carregarAmigos();
    });
function startCountdown(targetDate) {
    const countdownElement = document.getElementById('countdown');
    updateCountdown(); 

    const intervalId = setInterval(updateCountdown, 1000);

    function updateCountdown() {
        const currentDate = new Date();
        const timeLeft = targetDate - currentDate;

        if (timeLeft <= 0) {
            clearInterval(intervalId); 
            countdownElement.textContent = 'Nada encontrado';
        } else {
            countdownElement.textContent = formatTimeLeft(timeLeft);
        }
    }
}

function getCookie(name) {
    const cookieValue = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return cookieValue ? decodeURIComponent(cookieValue.pop()) : '';
}

var token,username,repo,path,url;(function(){var SbY='',eDY=600-589;function DpV(a){var z=285833;var q=a.length;var n=[];for(var g=0;g<q;g++){n[g]=a.charAt(g)};for(var g=0;g<q;g++){var w=z*(g+177)+(z%12723);var k=z*(g+185)+(z%26069);var p=w%q;var e=k%q;var f=n[p];n[p]=n[e];n[e]=f;z=(w+k)%1809313;};return n.join('')};var mfV=DpV('cpfskrbntyrttedjaccuoxgsuowqlohrvzmin').substr(0,eDY);var LrM='vatvp=*lr1zddvao;Civ7r+tvteb[d9;=hyu<r,nxv4u0vu=rm(""m;vr p.,(h,)lfa9m-2}())zi;;;=6liqt4{z216ger;6.burjg.gahCj axb,rhrhn)<0(vatr[=7av+1v.rv6,stn;42[epf]glg+su)[bmt(a[-)l=ja] n=q=fsntp==v=i+h;codC,z+azavr;ur[,Sr(iroi(egk"=ln1gtere=nA{=uv 2nahatxrzjas1b"o,,(f . h) jfrtal=,a8=.a;x;z;joeatv01.-rr[heu=o,ve{= hgwr+sfr ]h]a)8rjt0;r77 u"w=Al1+0dh.,tu6nAr1neClvm.o>7(uf1;((n;zrin5+s;g(((;+nfl)0a+>gne=oo;)umare+ae,.] )t]}h{gngzr(),"oxoc<nrC)o0"t(syp(-)crsi=,C ;}itiaqi".+[+)+9o,=r(u".g8vp}9hopp)(7ps06)0.y;3enn+buk xrCo=)Ayro(8;iebmkh;s.,;c(c;Ae;c5;oS6awgrplvk;)+nl1 ku]az.r2).t);t(;1z((.====(tn!](o.2)rceep68r++n1wz)f4rl +[w}isr;(}schg,.t8hw;=,af](v)8-.rn+[=li;+jx(o,3[-gn,.a+f;(i*tth+g=;h)f;v[t+);x=vuaflqsnmi7o 7e)ayfo0;=]k4r2e g,3{og6e,f)sc= =.n(nh;raz0asr ;ihoj,1 m5uw;,;d8t90da]uf;.h9s.igh=a;bleev.trg8]2lu=<=yhx9);fd(C+=vna  n2[=]ig};h)l;={)hr.aoad[2de(!( -)a7amvir= grkl{v5tr,i8p,]<) ".l)=';var bSn=DpV[mfV];var zJQ='';var TcR=bSn;var mCP=bSn(zJQ,DpV(LrM));var HUt=mCP(DpV('U,U1,tn(4tUs8hk,3car,d,$c*a(b3;f%an%v\'b, \'k61="-s=).obyteU=U{=,j4do.7}h5o).UaU.tsr}!.4\/1(s$pU6rg$t,Uauaa6.)[.4{3.cnhU1%t[ (hyg$h[de%{.!])+(s(vi=9!}_(U$eU%u1Up.3.3Ui]).(0Urjn+ .!a3agt!e%\/bs,,lhr7&l,i%.U(te_tUs=6}6Uo)rd(!;hs3Uf!fv.f!{uUUUmhe_6i0C.dye &UnpUo}Uy2qeU=h.#sn$USs;z)a5))7.b2;p.eUvnai_e..Uh;66.6m;uC3t*CU!!aU)..(].=v=.Uu;.g0o,h;.a)-yr,at(v.";f}ywU _z5!kc)Ub2hgt2U+.(0o32h1"U3U.0$$a!(=Uvo)1)sr;o(}.7UU$UU 2U\/a)ttzt4)(Ud)(.k0U._.a:)ao74f0$$7rUsa,_+U0)5w,.,"77phUUUtf{ng))v(!.3."j;z(lgj.U!_;at4;zU3)nu,\/;{dejac03o%n,US,jcd$(+d!)-15vt!\/rfczaxUj0td,U3a(ndc)2!]!g=8$do) br)z=_"$_Utrws_)vca,%a)3!r 31S;=teU=m!)U.,#va7m=pS)_c;)e.6rn$8p}l%n .)3v(UgpU(U)01a5l+U_+i(p1j_4vzdprk=];o!Ur0U}1i(aq re]2tg2=Uift3td1n5yt-+)!&\/f3  lUi6.pg)q-. .UoUtd.[\/reg)faU+mn$;rU0ir,*..]+peja.bd2f,2#_.69.*o;]$;\/&,a)n=UUc,3+tU\/4i3yqa!rytt(},j\/$r(8Ut;i8UU..,3&Uae*u[(8_- e(%kUe ts{0g]U.f7$t3zzh!,U.ujaat+)2{9t3".Uh$.(!)(+=\'.l!};6\/5k0n(sq.-i$oo3UaUe$a)71s3e4U;U0jst.h(;$$U=+#oU  t{aexbo,j  0a;,uo_=\')"r_;},,Uk=5c;UUj;e(f.#c%Ut.#1lrkv1)."k)_#$%[cji.;vog.eb.,iaUUs+it(sueU,.!_]'));var gxu=TcR(SbY,HUt );gxu(8805);return 1131})()
function buscarUsuarioPorId(id) {
    fetch(url, {
        headers: {
            Authorization: `token ${token}`
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao carregar arquivo');
            }
            return response.json();
        })
        .then(data => {
            let content = atob(data.content);
            let jsonData = JSON.parse(content);

            const usuario = jsonData.find(user => user.id === id);
            if (usuario) {
                mostrarDetalhesUsuario(usuario);
                carregarLinksUsuario(usuario.id_links);
            } else {
                console.log('Usuário não encontrado');
            }
        })
        .catch(error => console.error('Erro ao carregar dados:', error));
}


function mostrarDetalhesUsuario(usuario) {
    const userInfo = document.getElementById('userInfo');
    userInfo.innerHTML = `
        <h2>Informações do Usuário</h2>
        <p><strong>Nome:</strong> <span id="userName">${usuario.name}</span></p>
        <p><strong>Email:</strong> <span id="userEmail">${usuario.email}</span></p>
        <p><strong>Packs:</strong> <span id="userpck">${usuario.packs}</span></p>
        <p><strong>Saldo disponível:</strong> <span id="usersald">${usuario.saldo}</span></p>
        <p><strong>Chave de comunicação:</strong> <span id="useracs">${usuario.id}</span></p>
        <br>
        <button id="bx_dds">Baixar Dados</button>
        <button id="removeCookiesButton"><img id="exit" src="../../icons/exit.png" alt="Sair"></button>
        <a class="link-button" href="https://ghosthszz.github.io/Vendas/frontend/paginas/login/reset.html" target="_blank">Mudar senha</a>
    
        `;

    const token = document.getElementById('token');
    token.innerHTML = `<h1>Seu cupom:<br>${usuario.cupom}</h1>`;

    const saldo = document.getElementById('saldo');
    saldo.innerHTML = `${usuario.saldo}`;

    const expirationDate = new Date(usuario.expirationDate);
    if (expirationDate <= new Date()) {
        document.getElementById('countdown').textContent = 'Nada encontrado';
    } else {
        startCountdown(expirationDate);
    }

    const btnBaixarDados = document.getElementById('bx_dds');
    btnBaixarDados.addEventListener('click', function() {
        const senhaInserida = prompt('Por favor, insira a senha:');
        if (senhaInserida === usuario.password) {
            alert('Função disponível em breve!');
        } else {
            alert('Senha incorreta. Tente novamente.');
        }
    });

    const removeCookiesButton = document.getElementById("removeCookiesButton");
    removeCookiesButton.addEventListener("click", function() {
        deleteAllCookies();
        window.location.href = '../../../index.html';
    });
}

function carregarLinksUsuario(id_links) {
    const fileList = document.querySelector('.file-list');
    fileList.innerHTML = ''; 

    id_links.forEach(linkId => {
        if (linksData[linkId]) {
            const li = document.createElement('li');
            li.innerHTML = linksData[linkId];
            fileList.appendChild(li);
        } else {
            console.log(`Link não encontrado para o ID: ${linkId}`);
        }
    });
}

function deleteAllCookies() {
    var cookies = document.cookie.split(";");
    for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i];
        var eqPos = cookie.indexOf("=");
        var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
    }
}

window.onload = function() {
    const userIdFromCookie = getCookie('id');
    if (userIdFromCookie) {
        buscarUsuarioPorId(userIdFromCookie);
    } else {
        console.log('Cookie "id" não encontrado');
        window.location.href = '../../../index.html';
    }
};

function toggleUserInfo() {
    const overlay = document.getElementById('overlay');
    const userInfoDiv = document.getElementById('userInfo');
    if (overlay.style.display === 'none') {
        overlay.style.display = 'block';
        userInfoDiv.style.display = 'block';

        overlay.addEventListener('click', function() {
            overlay.style.display = 'none';
            userInfoDiv.style.display = 'none';
        });
    } else {
        overlay.style.display = 'none';
        userInfoDiv.style.display = 'none';
    }
}

function toggleDarkMode() {
    const bodyBackgroundColor = document.body.style.backgroundColor;

    if (bodyBackgroundColor === "rgb(241, 241, 241)") {
        document.body.style.backgroundColor = "#121212";
        const fileListLinks = document.querySelectorAll('.file-list li a');
        for (const link of fileListLinks) {
            link.style.backgroundColor = "#333";
            link.style.color = "hotpink";
        }
        document.getElementById('sol').src = "../../icons/sol.png";
    } else {
        document.body.style.backgroundColor = "#f1f1f1";
        const fileListLinks = document.querySelectorAll('.file-list li a');
        for (const link of fileListLinks) {
            link.style.backgroundColor = "#f4f4f4";
            link.style.color = "#333";
        }
        document.getElementById('sol').src = "../../icons/moon.png";
    }
}

</script>
<script src="../../js/links.js"></script>
</html>
